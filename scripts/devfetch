#!/usr/bin/env bash
# devfetch — true-color Sung Jinwoo portrait (left) + neofetch-style info (right)
#
# The portrait is loaded from config/jinwoo.art (generated by scripts/img2ascii).
# Regenerate it any time:
#   img2ascii Jin-Woo_Purple.webp 33 30 config/jinwoo.art

# ── Locate DevShell root ─────────────────────────────────────────
# Works whether called from .bashrc (with $_DEVSHELL_DIR set) or
# invoked directly as a command.
_DS_ROOT="${_DEVSHELL_DIR:-$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)}"

# ── Colors (for info column) ─────────────────────────────────────
R='\e[1;31m'; G='\e[1;32m'; B='\e[1;34m'
Y='\e[1;33m'; C='\e[1;36m'; M='\e[1;35m'
W='\e[1;37m'; DIM='\e[2;37m'; N='\e[0m'

# ── System info helpers ──────────────────────────────────────────
_cpu() {
    grep -m1 "model name" /proc/cpuinfo 2>/dev/null \
      | cut -d: -f2 \
      | sed 's/^ *//; s/(R)//g; s/(TM)//g; s/  */ /g; s/ @.*//' \
      | cut -c1-30
}
_ram() {
    local t a
    t=$(awk '/MemTotal/     { print $2 }' /proc/meminfo 2>/dev/null)
    a=$(awk '/MemAvailable/ { print $2 }' /proc/meminfo 2>/dev/null)
    [ -n "$t" ] && printf "%d MiB / %d MiB" $(( (t-a)/1024 )) $(( t/1024 )) || echo "—"
}
_uptime()  { uptime -p 2>/dev/null | sed 's/^up //' || echo '—'; }
_host_model() {
    local m
    m=$(wmic computersystem get model /format:value 2>/dev/null \
          | grep -i "^Model=" | cut -d= -f2 | tr -d '\r\n')
    echo "${m:-${COMPUTERNAME:-unknown}}"
}
_gpu() {
    wmic path Win32_VideoController get name /format:value 2>/dev/null \
      | grep -i "^Name=" | head -1 | cut -d= -f2 | tr -d '\r\n' \
      | cut -c1-30
}
_resolution() {
    local w h
    w=$(wmic path Win32_VideoController get CurrentHorizontalResolution \
          /format:value 2>/dev/null | grep -o '[0-9]\+' | head -1)
    h=$(wmic path Win32_VideoController get CurrentVerticalResolution \
          /format:value 2>/dev/null | grep -o '[0-9]\+' | head -1)
    [ -n "$w" ] && echo "${w}x${h}" || echo "unknown"
}
_packages() {
    local n
    n=$(ls -1 "${_DS_ROOT}/scripts" 2>/dev/null | wc -l)
    echo "${n} (devshell)"
}
_terminal() {
    if   [ -n "$WT_SESSION" ];   then echo "Windows Terminal"
    elif [ -n "$TERM_PROGRAM" ]; then echo "$TERM_PROGRAM"
    elif [ -n "$TERM" ];         then echo "$TERM"
    else                              echo "Git Bash"
    fi
}

# ── Gather data ──────────────────────────────────────────────────
_user="${USER:-user}"; _host="${HOSTNAME%%.*}"
_kernel=$(uname -r 2>/dev/null)
_sh="bash ${BASH_VERSION%%\(*}"
_cpu_str="$(_cpu)"; _ram_str="$(_ram)"; _up="$(_uptime)"
_model="$(_host_model)"; _gpu_str="$(_gpu)"; _res="$(_resolution)"
_pkgs="$(_packages)"; _term="$(_terminal)"

# ── Label helper — "Label:" left-padded to 12 chars ──────────────
_lbl() { printf "${C}%-12s${N}%s" "$1" "$2"; }

# ── Info lines (right column, anchored to column 36 by _row) ─────
info=(
    "${G}${_user}${N}${DIM}@${N}${G}${_host}${N}"
    "${DIM}─────────────────────────────${N}"
    "$(_lbl 'OS:'         "Windows 10 x86_64")"
    "$(_lbl 'Host:'       "${_model}")"
    "$(_lbl 'Kernel:'     "${_kernel}")"
    "$(_lbl 'Uptime:'     "${_up}")"
    "$(_lbl 'Packages:'   "${_pkgs}")"
    "$(_lbl 'Shell:'      "${_sh}")"
    "$(_lbl 'Resolution:' "${_res}")"
    "$(_lbl 'Terminal:'   "${_term}")"
    "$(_lbl 'CPU:'        "${_cpu_str}")"
    "$(_lbl 'GPU:'        "${_gpu_str}")"
    "$(_lbl 'Memory:'     "${_ram_str}")"
    ""
    "\e[0;30m████\e[0m \e[0;31m████\e[0m \e[0;32m████\e[0m \e[0;33m████\e[0m \e[0;34m████\e[0m \e[0;35m████\e[0m \e[0;36m████\e[0m \e[0;37m████\e[0m"
    "\e[1;30m████\e[0m \e[1;31m████\e[0m \e[1;32m████\e[0m \e[1;33m████\e[0m \e[1;34m████\e[0m \e[1;35m████\e[0m \e[1;36m████\e[0m \e[1;37m████\e[0m"
    "" "" "" "" "" "" "" "" "" "" "" "" "" ""
)

# ── Load portrait from pre-generated art file ────────────────────
# config/jinwoo.art contains true-color ANSI escape sequences
# generated by:  img2ascii Jin-Woo_Purple.webp 33 30 config/jinwoo.art
_ART_FILE="${_DS_ROOT}/config/jinwoo.art"
if [[ -f "$_ART_FILE" ]]; then
    mapfile -t art < "$_ART_FILE"
else
    art=()
    printf "\e[1;33mWarning:\e[0m %s not found. Run:\n" "$_ART_FILE" >&2
    printf "  img2ascii Jin-Woo_Purple.webp 33 30 config/jinwoo.art\n" >&2
fi

# ── Side-by-side renderer ────────────────────────────────────────
# Art lines contain raw ESC bytes → printf %s passes them through unchanged.
# Info lines use \e[...m notation   → printf %b interprets the escapes.
# \e[36G (Cursor Horizontal Absolute) jumps to column 36 regardless of
# how many invisible bytes are in the art, keeping the info aligned.
_row() {
    printf "  %s"  "$1"     # art  — raw ANSI, no interpretation needed
    printf "\e[36G"          # jump to column 36
    printf "%b\n" "$2"       # info — interpret \e[...m sequences
}

# ── Main ─────────────────────────────────────────────────────────
echo ""
max=$(( ${#art[@]} > ${#info[@]} ? ${#art[@]} : ${#info[@]} ))
for (( i=0; i<max; i++ )); do
    _row "${art[$i]:-}" "${info[$i]:-}"
    sleep 0.04
done
echo ""
